STORE 'C:TESTFILE' TO USEFILE
SET TALK OFF
* TURN ON FILE LOCKING
POKE 8,1
* CREATE AN INFINITE LOOP
STORE -1 TO ALL
DO WHILE ALL <> 0
  STORE -1 TO LOCK
  DO WHILE LOCK <> 0
    * BE SURE TESTFILE.CMD IS ON DRIVE C:
    RESET C:
    * REQUEST FILE FOR READ/WRITE
    POKE 65,90
    * OPEN FILE
    USE &USEFILE
    * SAVE LOCK STATUS
    STORE PEEK(64) TO LOCK
    IF LOCK <> 0
      ? 'FILE LOCKED - PLEASE WAIT'
      ? 'PRESS RETURN TO TRY AGAIN'
      ? 'PRESS ESCAPE TO CANCEL DO'
      * RESTORE LOCK FLAG TO 64
      POKE 64,LOCK
      * CLOSE THE FILE
      USE
      * WAIT FOR RETURN OR ESCAPE
      WAIT
    ENDIF
  * LOOP UNTIL FILE ACCESS IS GRANTED
  ENDDO
  LIST
  * FORCE A FILE UPDATE!!!
  REPLACE NAME WITH NAME
  ? 'PRESS RETURN TO CLOSE & UNLOCK IT'
  WAIT
  * RESTORE LOCK FLAG
  POKE 64,LOCK
  * CLOSE FILE & UNLOCK IT
  USE
  ? 'FILE CLOSED.'
  ? 'PRESS RETURN TO REPEAT'
  WAIT
ENDDO
