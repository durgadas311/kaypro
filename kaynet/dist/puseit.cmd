IF OPEN:P <> 0
  * RESTORE OLD LOCK VALUE
  POKE 64,LOCK:P
  * CLOSE OLD FILE
  USE
  * FLAG FILE CLOSED
  STORE 0 TO OPEN:P
  * RESET DISK SYSTEM TO WRITE OUT DATA FOR FILE CLOSE
  RESET &DBFDRIVE:P
ENDIF
STORE '&DBFDRIVE:P'+'&USEFILE' TO USETEMP
IF $(USEFILE,1,1) <> ' '
  * OPEN FILE IF A FILENAME WAS SPECIFIED
  STORE -1 TO LOCK:P
  DO WHILE LOCK:P <> 0
    RESET &DBFDRIVE:P
    * OPEN FILE FOR READ/WRITE
    POKE 65,90
    USE &USETEMP
    * SAVE LOCK STATUS
    STORE PEEK(64) TO LOCK:P
    IF LOCK:P <> 0
      ? 'FILE LOCKED - PLEASE WAIT'
      ? 'PRESS RETURN TO TRY AGAIN'
      ? 'PRESS ESCAPE TO CANCEL DO'
      POKE 64,LOCK:P
      USE
      WAIT
      * WAIT FOR KEYPRESS, THEN TRY TO OPEN FILE AGAIN
    ENDIF
    * REPEAT UNTIL FILE ACCESS IS GRANTED
  ENDDO
  STORE -1 TO OPEN:P
ENDIF
RELEASE USETEMP
